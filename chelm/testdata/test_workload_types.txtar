# Various Kubernetes workload types all extract images correctly
chelm test cg.json --chart=chart
cmp stdout expected.json

-- cg.json --
{
  "images": {
    "statefulset-app": {
      "values": {
        "statefulset": {"image": "${ref}"}
      }
    },
    "daemonset-app": {
      "values": {
        "daemonset": {"image": "${ref}"}
      }
    },
    "job-app": {
      "values": {
        "job": {"image": "${ref}"}
      }
    },
    "cronjob-app": {
      "values": {
        "cronjob": {"image": "${ref}"}
      }
    },
    "pod-app": {
      "values": {
        "pod": {"image": "${ref}"}
      }
    },
    "replicaset-app": {
      "values": {
        "replicaset": {"image": "${ref}"}
      }
    }
  },
  "test": {
    "cases": [
      {"name": "default", "images": ["statefulset-app", "daemonset-app", "job-app", "cronjob-app", "pod-app", "replicaset-app"]}
    ]
  }
}

-- chart/Chart.yaml --
apiVersion: v2
name: test-chart
version: 0.1.0

-- chart/templates/statefulset.yaml --
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: test-sts
spec:
  serviceName: test
  template:
    spec:
      containers:
        - name: app
          image: {{ .Values.statefulset.image }}

-- chart/templates/daemonset.yaml --
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: test-ds
spec:
  template:
    spec:
      containers:
        - name: app
          image: {{ .Values.daemonset.image }}

-- chart/templates/job.yaml --
apiVersion: batch/v1
kind: Job
metadata:
  name: test-job
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: app
          image: {{ .Values.job.image }}

-- chart/templates/cronjob.yaml --
apiVersion: batch/v1
kind: CronJob
metadata:
  name: test-cronjob
spec:
  schedule: "0 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: app
              image: {{ .Values.cronjob.image }}

-- chart/templates/pod.yaml --
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
    - name: app
      image: {{ .Values.pod.image }}

-- chart/templates/replicaset.yaml --
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: test-rs
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test
  template:
    metadata:
      labels:
        app: test
    spec:
      containers:
        - name: app
          image: {{ .Values.replicaset.image }}

-- chart/values.yaml --
statefulset:
  image: redis:7
daemonset:
  image: fluentd:v1.16
job:
  image: busybox:1.36
cronjob:
  image: alpine:3.19
pod:
  image: nginx:1.25
replicaset:
  image: httpd:2.4

-- expected.json --
{
  "passed": true,
  "cases": [
    {
      "name": "default",
      "passed": true,
      "images": [
        "cgr.test/chainguard/test/cronjob-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "cgr.test/chainguard/test/daemonset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "cgr.test/chainguard/test/job-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "cgr.test/chainguard/test/pod-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "cgr.test/chainguard/test/replicaset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "cgr.test/chainguard/test/statefulset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
      ],
      "extractors": {
        "regex": [
          "cgr.test/chainguard/test/cronjob-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/daemonset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/job-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/pod-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/replicaset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/statefulset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
        ],
        "structured": [
          "cgr.test/chainguard/test/cronjob-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/daemonset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/job-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/pod-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/replicaset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "cgr.test/chainguard/test/statefulset-app@sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
        ]
      }
    }
  ]
}
