name: contains-files

inputs:
  dir:
    description: |
      Directory to look into. Defaults to /usr.
      Examples:
        dir: "/usr/lib/"
    required: false
    default: "" # Default to /usr gets set in the script.
  name:
    description: |
      A find-like name expression. Defaults to * (i.e, match anything).
    required: false
    default: "" # Default to * gets set in the script.
  type:
    description: |
      File type for `find -type`: f (file), d (dir), l (symlink). Default: f
    required: false
    default: "f"
  files:
    description: |
      List of exact paths to check for existence (newline or space separated).
      If combined with dir/name, both checks run.
    required: false
    default: ""

# USAGE EXAMPLES:
#
#   - uses: test/tw/contains-files
#     with:
#       dir: /usr/lib/
#       name: libre2.so
#
#   - uses: test/tw/contains-files
#     with:
#       dir: /opt/
#       name: some-binary-link
#       type: l
#
#    - uses: test/tw/contains-files
#      with:
#        dir: "/usr/lib/ruby/gems/"
#        name: "*.rbs"
#
#    - uses: test/tw/contains-files
#      with:
#        files: |
#          /usr/lib/ruby/gems/3.3.0/gems/webrick-1.9.2/Gemfile
#          /usr/lib/ruby/gems/3.3.0/gems/webrick-1.9.2/sig/cgi.rbs
#
#    # files + dir + name (all three): runs BOTH checks
#    - uses: test/tw/contains-files
#      with:
#        files: |
#          /usr/bin/bash
#          /etc/os-release
#        dir: /usr/lib/
#        name: "libre2.so"
#        type: f
pipeline:
  - runs: |
      # Get raw inputs (all empty by default)
      files="${{inputs.files}}"
      dir="${{inputs.dir}}"
      name="${{inputs.name}}"
      type="${{inputs.type}}"
      failed=false

      # Determine what the user actually wants:
      # - If NOTHING specified → apply sensible defaults
      # - If ANYTHING specified → only use what they gave us

      # If user provided ANY input, keep it. Otherwise apply defaults.
      if [ -z "${files}" ] && [ -z "${dir}" ] && [ -z "${name}" ]; then
        echo "No inputs specified, using defaults... dir=/usr, name=*"
        dir="/usr"
        name="*"
      fi

      # if only dir is specified set name to * and vice versa dir to /usr
      if [ -n "${dir}" ] && [ -z "${name}" ]; then
        name="*"
      fi
      if [ -z "${dir}" ] && [ -n "${name}" ]; then
        dir="/usr"
      fi

      # Now run checks based on what we have

      # Check specific files if provided
      if [ -n "${files}" ]; then
        echo "Checking specific files..."

        for file in ${files}; do
          [ -z "${file}" ] && continue
          if [ ! -e "${file}" ]; then
            echo "FAIL: ${file} not found" >&2
            failed=true
          else
            echo "PASS: ${file} exists."
          fi
        done
      fi

      # Check pattern if dir/name were provided (or if nothing was specified)
      if [ -n "${dir}" ] && [ -n "${name}" ]; then
        echo "Checking pattern '${name}' in ${dir}..."
        list="$(find "${dir}" -name "${name}" -type "${type}" 2>/dev/null)"

        if [ -z "${list}" ]; then
          echo "FAIL: no files matching '${name}' in ${dir}" >&2
          failed=true
        else
          count="$(echo "${list}" | wc -l)"
          echo "PASS: found ${count} file(s) matching '${name}' in ${dir}"
        fi
      fi

      [ "${failed}" = "true" ] && exit 1
