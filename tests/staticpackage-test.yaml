package:
  name: staticpackage-test
  version: "0.0.0"
  epoch: 0
  description: Test for staticpackage-test pipeline validation
  options:
    no-provides: true
  dependencies:
    provider-priority: 0
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - busybox

pipeline:
  - runs: |
      echo "Test package for staticpackage-test pipeline validation"

subpackages:
  # Positive test: Valid static package from Wolfi (contains *.a libraries)
  - name: gdcm-static
    description: gdcm static package from Wolfi
    pipeline:
      - runs: echo "Demo build for gdcm-static already present in wolfi"
    test:
      pipeline:
        - uses: test/tw/staticpackage

  # Negative test: Non-docs Wolfi package (glibc)
  - name: glibc
    description: Non-documentation package from Wolfi (should fail docs check)
    pipeline:
      - runs: echo "Demo build for glibc - this is NOT a docs package"
    test:
      environment:
        contents:
          packages:
            - package-type-check
      pipeline:
        - name: Verify pipeline correctly rejects non-docs package
          runs: |
            set +e
            output=$(package-type-check static "${{context.name}}" 2>&1)
            result=$?
            echo "=== Output from package-type-check ==="
            echo "$output"
            echo "=== Exit code: $result ==="
            if [ $result -eq 0 ]; then
              echo "FAIL: Pipeline should have rejected non-static package (glibc)" >&2
              exit 1
            fi
            echo "PASS: Pipeline correctly rejected non-static Wolfi package"

  # positive manual test contains only static libs
  - name: contains-only-static
    description: "Positive test: Valid static package from Wolfi (contains *.a libraries)"
    pipeline:
      - runs: |
          # create a directory for static libraries
          mkdir -p ${{targets.subpkgdir}}/usr/lib/
          # create a static libraries in the lib directory
          touch ${{targets.subpkgdir}}/usr/lib/libexample.a
    test:
      pipeline:
        - uses: test/tw/staticpackage

  # negative manual test contains static + other libs
  - name: contains-static-and-more
    description: "Negative test: Invalid static package from Wolfi (contains *.so libraries)"
    pipeline:
      - runs: |
          # create a directory for static libraries
          mkdir -p ${{targets.subpkgdir}}/usr/lib/
          # create a static libraries in the lib directory
          touch ${{targets.subpkgdir}}/usr/lib/libexample.so
          # create a shared library in the lib directory
          touch ${{targets.subpkgdir}}/usr/lib/libexample.so.1
    test:
      environment:
        contents:
          packages:
            - package-type-check
      pipeline:
        - name: Verify pipeline correctly rejects non-docs package
          runs: |
            set +e
            output=$(package-type-check static "${{context.name}}" 2>&1)
            result=$?
            echo "=== Output from package-type-check ==="
            echo "$output"
            echo "=== Exit code: $result ==="
            if [ $result -eq 0 ]; then
              echo "FAIL: Pipeline should have rejected non-static package (glibc)" >&2
              exit 1
            fi
            echo "PASS: Pipeline correctly rejected non-static Wolfi package"
